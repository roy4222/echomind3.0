# Services 服務層

## 功能概述

`services` 目錄包含應用核心業務邏輯和外部服務整合的實現。這些服務被 handlers 調用，提供資料處理、外部 API 交互和資源管理等功能。服務層隔離了具體實現細節，使處理器層能夠專注於請求處理流程。

## 檔案結構

```
services/
├── embedding.ts  - 文本向量嵌入服務
├── pinecone.ts   - 向量資料庫交互服務
└── storage.ts    - 檔案儲存服務
```

## 主要元件說明

### embedding.ts

提供文本向量化服務，將文字轉換為高維數值向量，用於語義搜尋。

**主要功能**：
- 使用 Cohere API 生成文本的向量嵌入
- 支援多語言向量模型（embed-multilingual-v3.0）
- 提供備用機制，在 API 不可用時生成模擬嵌入向量
- 相容不同版本的 Cohere API 回應格式

**核心邏輯**：
- `generateEmbedding()`: 接收文字輸入，調用 Cohere API 生成 1024 維度的向量表示

### pinecone.ts

提供向量資料庫交互能力，主要用於 FAQ 檢索功能。

**主要功能**：
- 連接 Pinecone 向量資料庫服務
- 執行向量相似度搜尋，找出與查詢最相關的內容
- 支援不同的 Pinecone 環境配置（標準環境和 gcp-starter）
- 結果過濾與排序，優化檢索質量

**核心邏輯**：
- `PineconeClient` 類: 封裝與 Pinecone 的所有交互邏輯
- `searchFaqs()`: 執行向量檢索，返回結構化的 FAQ 搜尋結果

### storage.ts

管理檔案儲存功能，主要用於處理用戶上傳的圖片和其他文件。

**主要功能**：
- 與 Cloudflare R2 儲存服務整合（相容 S3 API）
- 提供檔案上傳、檢索服務
- 檔案大小驗證和限制
- 生成公開可訪問的檔案 URL

**核心邏輯**：
- `StorageService` 類: 封裝所有儲存操作
- `uploadFile()`: 將檔案內容上傳至 R2 儲存
- `getFileUrl()`: 生成檔案的訪問 URL
- `isFileSizeExceeded()`: 檢查檔案大小是否超過限制

## 設計原則

- **服務封裝**: 將複雜的外部服務交互邏輯封裝在專用類中
- **關注點分離**: 每個服務專注於一個特定領域
- **錯誤處理**: 提供詳細的錯誤日誌和優雅的錯誤處理
- **資源最佳化**: 使用客戶端快取和單例模式優化資源使用
- **彈性設計**: 提供備用機制和配置選項，增強系統彈性
