# Middlewares 中間件層

## 功能概述

`middlewares` 目錄包含應用的中間件，負責在請求處理過程中執行橫切關注點的邏輯，例如身份驗證、請求日誌、數據轉換等。中間件在處理器執行前或後運行，確保請求滿足特定的前置條件。

## 檔案結構

```
middlewares/
└── auth.ts  - 身份驗證中間件
```

## 主要元件說明

### auth.ts

提供身份驗證和授權功能，驗證用戶的身份並控制資源訪問權限。

**主要功能**：
- 解析並驗證授權標頭中的 JWT 令牌
- 提取用戶身份資訊（用戶 ID、名稱、電子郵件、角色等）
- 返回標準化的驗證結果，供處理器使用

**核心邏輯**：
- `verifyAuth()`: 驗證請求中的授權令牌，返回包含驗證狀態和用戶資訊的結果
- `AuthResult` 介面: 定義標準化的驗證結果結構

**當前實現說明**：
- 現階段使用模擬驗證邏輯，預留了未來整合 Firebase Auth 或其他 JWT 驗證服務的介面
- 處理各種授權錯誤情況，提供清晰的錯誤訊息

## 使用方式

中間件通常在處理器中以以下方式調用：

```typescript
// 在處理請求前驗證用戶身份
const authResult = await verifyAuth(request, env);
if (!authResult.isAuthenticated) {
  return createErrorResponse('未授權', 401, request);
}

// 使用用戶資訊
const userId = authResult.user?.uid;
```

## 設計原則

- **可組合性**: 中間件可以靈活組合，處理不同的橫切關注點
- **單一職責**: 每個中間件專注於一種特定的功能
- **透明性**: 中間件應對處理器透明，不應改變請求處理的基本流程
- **可配置性**: 提供配置選項，根據需要啟用或禁用特定功能
- **標準化**: 遵循統一的介面約定，便於整合和使用
